{% extends "base.html" %}
{% load static %}

{% block body %}
<!-- App Layout with Sidebar -->
<div class="app-wrapper" data-sidebar-collapsed="false">
    <!-- Sidebar -->
    <aside class="app-sidebar" id="appSidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="var(--primary-color)"/>
                    <path d="M20 10L30 16.25V23.75L20 30L10 23.75V16.25L20 10Z" fill="white"/>
                </svg>
                <span class="sidebar-logo-text">{{ site_name|default:"SaaS Platform" }}</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle" type="button">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <div class="sidebar-content">
            <!-- Search -->
            <div class="sidebar-search">
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Search... (Ctrl+K)"
                        data-search
                        id="globalSearch"
                    >
                    <kbd class="search-kbd">âŒ˜K</kbd>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                {% block sidebar_nav %}
                <!-- Admin Panel Navigation -->
                {% if user.role == 'SUPER_ADMIN' %}
                <div class="nav-section">
                    <div class="nav-section-title">Admin Panel</div>
                    <a href="/admin-panel/dashboard/" class="nav-item {% if request.path == '/admin-panel/dashboard/' %}active{% endif %}">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/admin-panel/tenants/" class="nav-item {% if '/admin-panel/tenants/' in request.path %}active{% endif %}">
                        <i class="fas fa-building"></i>
                        <span>Tenants</span>
                        {% if pending_tenants_count > 0 %}
                        <span class="badge badge-primary">{{ pending_tenants_count }}</span>
                        {% endif %}
                    </a>
                    <a href="/admin-panel/payments/" class="nav-item {% if '/admin-panel/payments/' in request.path %}active{% endif %}">
                        <i class="fas fa-credit-card"></i>
                        <span>Payments</span>
                        {% if pending_payments_count > 0 %}
                        <span class="badge badge-warning">{{ pending_payments_count }}</span>
                        {% endif %}
                    </a>
                    <a href="/admin-panel/analytics/" class="nav-item {% if '/admin-panel/analytics/' in request.path %}active{% endif %}">
                        <i class="fas fa-chart-pie"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="/admin-panel/users/" class="nav-item {% if '/admin-panel/users/' in request.path %}active{% endif %}">
                        <i class="fas fa-users-cog"></i>
                        <span>Internal Users</span>
                    </a>
                    <a href="/admin-panel/audit-logs/" class="nav-item {% if '/admin-panel/audit-logs/' in request.path %}active{% endif %}">
                        <i class="fas fa-history"></i>
                        <span>Audit Logs</span>
                    </a>
                </div>
                {% else %}
                <!-- Tenant Navigation -->
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="/dashboard/" class="nav-item {% if request.path == '/dashboard/' %}active{% endif %}">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/tasks/" class="nav-item {% if '/tasks/' in request.path %}active{% endif %}">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                        {% if my_tasks_count > 0 %}
                        <span class="badge badge-danger">{{ my_tasks_count }}</span>
                        {% endif %}
                    </a>
                    <a href="/teams/" class="nav-item {% if '/teams/' in request.path %}active{% endif %}">
                        <i class="fas fa-users"></i>
                        <span>Teams</span>
                    </a>
                    <a href="/calendar/" class="nav-item {% if '/calendar/' in request.path %}active{% endif %}">
                        <i class="fas fa-calendar"></i>
                        <span>Calendar</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="/billing/" class="nav-item {% if '/billing/' in request.path %}active{% endif %}">
                        <i class="fas fa-wallet"></i>
                        <span>Billing</span>
                        {% if subscription_expiring %}
                        <span class="badge badge-warning">!</span>
                        {% endif %}
                    </a>
                    <a href="/settings/" class="nav-item {% if '/settings/' in request.path %}active{% endif %}">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <a href="/help/" class="nav-item {% if '/help/' in request.path %}active{% endif %}">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </a>
                </div>
                {% endif %}
                {% endblock %}
            </nav>

            <!-- Upgrade CTA -->
            {% if user.role != 'SUPER_ADMIN' and current_tenant.subscription.plan.name != 'Enterprise' %}
            <div class="sidebar-upgrade-cta">
                <div class="upgrade-card">
                    <i class="fas fa-rocket upgrade-icon"></i>
                    <h4 class="upgrade-title">Upgrade to Pro</h4>
                    <p class="upgrade-text">Unlock advanced features</p>
                    <a href="/billing/upgrade/" class="btn btn-primary btn-sm btn-block">
                        Upgrade Now
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="user-menu-trigger" id="userMenuTrigger">
                <div class="user-avatar">
                    {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="{{ user.full_name }}">
                    {% else %}
                    <div class="avatar">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                    {% endif %}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.full_name }}</div>
                    <div class="user-role">{{ user.get_role_display }}</div>
                </div>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="app-main">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobileMenuToggle" type="button">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="breadcrumb">
                    {% block breadcrumb %}
                    <a href="/">Home</a>
                    {% endblock %}
                </div>
            </div>

            <div class="header-right">
                <!-- Dark Mode Toggle -->
                <button class="header-icon-btn" id="darkModeToggle" type="button" title="Toggle Dark Mode (Ctrl+D)">
                    <i class="fas fa-moon"></i>
                </button>

                <!-- Notifications -->
                <div class="dropdown" id="notificationsDropdown">
                    <button class="header-icon-btn" type="button">
                        <i class="fas fa-bell"></i>
                        {% if unread_notifications_count > 0 %}
                        <span class="notification-badge">{{ unread_notifications_count }}</span>
                        {% endif %}
                    </button>
                    <div class="dropdown-menu dropdown-menu-wide">
                        <div class="dropdown-header">
                            <h4>Notifications</h4>
                            <a href="#" class="mark-all-read">Mark all read</a>
                        </div>
                        <div class="notifications-list">
                            {% if notifications %}
                            {% for notification in notifications|slice:":5" %}
                            <a href="{{ notification.link }}" class="notification-item {% if not notification.is_read %}unread{% endif %}">
                                <div class="notification-icon {{ notification.type }}">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="notification-content">
                                    <div class="notification-title">{{ notification.title }}</div>
                                    <div class="notification-time">{{ notification.created_at|timesince }} ago</div>
                                </div>
                            </a>
                            {% endfor %}
                            {% else %}
                            <div class="empty-state" style="padding: 40px 20px;">
                                <i class="fas fa-bell-slash empty-state-icon" style="font-size: 32px;"></i>
                                <p style="margin-top: 12px;">No notifications</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="dropdown-footer">
                            <a href="/notifications/">View all</a>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dropdown" id="quickActionsDropdown">
                    <button class="header-icon-btn" type="button">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item" onclick="openCreateTaskModal(); return false;">
                            <i class="fas fa-tasks"></i>
                            <span>New Task</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="openCreateTeamModal(); return false;">
                            <i class="fas fa-users"></i>
                            <span>New Team</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" onclick="openInviteMemberModal(); return false;">
                            <i class="fas fa-user-plus"></i>
                            <span>Invite Member</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="app-content">
            {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <i class="fas fa-info-circle alert-icon"></i>
                    <div class="alert-content">{{ message }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block app_content %}{% endblock %}
        </main>
    </div>
</div>

<!-- User Menu Dropdown -->
<div class="user-menu-dropdown" id="userMenuDropdown" style="display: none;">
    <a href="/profile/" class="dropdown-item">
        <i class="fas fa-user"></i>
        <span>Profile</span>
    </a>
    <a href="/settings/" class="dropdown-item">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
    </a>
    <a href="/help/" class="dropdown-item">
        <i class="fas fa-question-circle"></i>
        <span>Help</span>
    </a>
    <div class="dropdown-divider"></div>
    <a href="/logout/" class="dropdown-item">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
    </a>
</div>

<link rel="stylesheet" href="{% static 'css/app-layout.css' %}">
<script src="{% static 'js/app-layout.js' %}"></script>
{% endblock %}