{% extends "layouts/app_enhanced.html" %}
{% load static %}

{% block title %}Admin Dashboard - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<a href="/admin-panel/dashboard/">Admin Panel</a>
<i class="fas fa-chevron-right" style="font-size: 12px; color: var(--text-tertiary);"></i>
<span>Dashboard</span>
{% endblock %}

{% block app_content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Manage tenants, payments, and platform analytics</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-ghost" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
        <button class="btn btn-primary" onclick="openCreateTenantModal()">
            <i class="fas fa-plus"></i>
            Create Tenant
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-building"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_tenants|default:0 }}</div>
            <div class="stat-label">Total Tenants</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +{{ new_tenants_this_month|default:0 }} this month
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ pending_approvals|default:0 }}</div>
            <div class="stat-label">Pending Approvals</div>
            <div class="stat-change">
                <i class="fas fa-exclamation-circle"></i>
                Requires attention
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">${{ monthly_revenue|floatformat:0|default:"0" }}</div>
            <div class="stat-label">Monthly Revenue (MRR)</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +{{ revenue_growth|floatformat:1|default:"0" }}%
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon info">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ active_users|default:0 }}</div>
            <div class="stat-label">Active Users</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +{{ new_users_today|default:0 }} today
            </div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
    <!-- Tenants Table -->
    <div class="content-section">
        <div class="card">
            <div class="card-header">
                <div>
                    <h3 class="card-title">Tenants Management</h3>
                    <p class="card-subtitle">Manage all tenant accounts and approvals</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-ghost btn-sm" onclick="exportTenants()">
                        <i class="fas fa-download"></i>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="table-toolbar">
                <div class="toolbar-left">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="Search tenants..."
                            id="tenantSearch"
                            onkeyup="filterTenants()"
                        >
                    </div>
                </div>
                <div class="toolbar-right">
                    <select class="form-control form-control-sm" id="statusFilter" onchange="filterTenants()">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="PENDING">Pending</option>
                        <option value="SUSPENDED">Suspended</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                    <select class="form-control form-control-sm" id="planFilter" onchange="filterTenants()">
                        <option value="">All Plans</option>
                        <option value="free">Free</option>
                        <option value="starter">Starter</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="table table-hover" id="tenantsTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="sortable" onclick="sortTable(1)">
                                Company
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" onclick="sortTable(2)">
                                Contact
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" onclick="sortTable(3)">
                                Plan
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" onclick="sortTable(4)">
                                Status
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" onclick="sortTable(5)">
                                Created
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if tenants %}
                        {% for tenant in tenants %}
                        {% with active_sub=tenant.subscriptions.all|first %}
                        <tr data-status="{{ tenant.status }}" data-plan="{% if active_sub %}{{ active_sub.plan.name|lower }}{% else %}free{% endif %}">
                            <td>
                                <input type="checkbox" class="tenant-checkbox" value="{{ tenant.id }}">
                            </td>
                            <td>
                                <div class="tenant-info">
                                    <div class="tenant-logo">
                                        {% if tenant.logo %}
                                        <img src="{{ tenant.logo.url }}" alt="{{ tenant.name }}">
                                        {% else %}
                                        <div class="avatar">{{ tenant.name|first }}</div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="tenant-name">{{ tenant.name }}</div>
                                        <div class="tenant-domain">{{ tenant.slug }}.yourdomain.com</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ tenant.company_name }}</div>
                                <div class="text-muted">{{ tenant.company_email }}</div>
                            </td>
                            <td>
                                {% if active_sub %}
                                <span class="badge badge-primary">{{ active_sub.plan.name }}</span>
                                {% else %}
                                <span class="badge badge-secondary">No Plan</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tenant.status == 'ACTIVE' %}
                                <span class="badge badge-success badge-dot">Active</span>
                                {% elif tenant.status == 'PENDING' %}
                                <span class="badge badge-warning badge-dot">Pending</span>
                                {% elif tenant.status == 'SUSPENDED' %}
                                <span class="badge badge-danger badge-dot">Suspended</span>
                                {% else %}
                                <span class="badge badge-secondary badge-dot">{{ tenant.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ tenant.created_at|date:"M d, Y" }}</div>
                                <div class="text-muted">{{ tenant.created_at|timesince }} ago</div>
                            </td>
                            <td class="text-right">
                                <div class="btn-group">
                                    <a href="/admin-panel/tenants/{{ tenant.id }}/" class="btn btn-sm btn-ghost" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if tenant.status == 'PENDING' %}
                                    <button class="btn btn-sm btn-success" onclick="approveTenant({{ tenant.id }})" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-ghost" onclick="toggleTenantStatus({{ tenant.id }})" title="Toggle Status">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <button class="btn btn-sm btn-ghost" onclick="sendMessage({{ tenant.id }})" title="Send Message">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-building empty-state-icon"></i>
                                    <h4 class="empty-state-title">No Tenants Found</h4>
                                    <p class="empty-state-description">Get started by creating your first tenant</p>
                                    <button class="btn btn-primary" onclick="openCreateTenantModal()">
                                        <i class="fas fa-plus"></i>
                                        Create Tenant
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if tenants.has_other_pages %}
            <div class="table-footer">
                <div class="pagination-info">
                    Showing {{ tenants.start_index }} to {{ tenants.end_index }} of {{ tenants.paginator.count }} tenants
                </div>
                <div class="pagination">
                    {% if tenants.has_previous %}
                    <button class="pagination-item" onclick="goToPage({{ tenants.previous_page_number }})">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    {% else %}
                    <button class="pagination-item" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    {% endif %}
                    
                    {% for num in tenants.paginator.page_range %}
                    {% if tenants.number == num %}
                    <button class="pagination-item active">{{ num }}</button>
                    {% else %}
                    <button class="pagination-item" onclick="goToPage({{ num }})">{{ num }}</button>
                    {% endif %}
                    {% endfor %}
                    
                    {% if tenants.has_next %}
                    <button class="pagination-item" onclick="goToPage({{ tenants.next_page_number }})">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    {% else %}
                    <button class="pagination-item" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar Stats -->
    <div class="sidebar-stats">
        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="activity-list">
                {% if recent_activities %}
                {% for activity in recent_activities|slice:":10" %}
                <div class="activity-item">
                    <div class="activity-icon {{ activity.type }}">
                        <i class="fas {{ activity.icon }}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">{{ activity.title }}</div>
                        <div class="activity-time">{{ activity.created_at|timesince }} ago</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" style="padding: 20px;">
                    <i class="fas fa-history" style="font-size: 32px; color: var(--text-tertiary);"></i>
                    <p style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Quick Stats</h3>
            </div>
            <div class="quick-stats">
                <div class="quick-stat-item">
                    <div class="quick-stat-label">Conversion Rate</div>
                    <div class="quick-stat-value">{{ conversion_rate|floatformat:1|default:"0" }}%</div>
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ conversion_rate }}%"></div>
                    </div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-label">Avg. Revenue Per Tenant</div>
                    <div class="quick-stat-value">${{ avg_revenue_per_tenant|floatformat:0|default:"0" }}</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-label">Churn Rate</div>
                    <div class="quick-stat-value">{{ churn_rate|floatformat:1|default:"0" }}%</div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-danger" style="width: {{ churn_rate }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}

.page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.page-subtitle {
    color: var(--text-secondary);
    margin-top: 4px;
}

.page-actions {
    display: flex;
    gap: 12px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    display: flex;
    gap: 16px;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.stat-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-color); }
.stat-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
.stat-icon.primary { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
.stat-icon.info { background: rgba(59, 130, 246, 0.1); color: var(--info-color); }

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 14px;
    margin-top: 8px;
}

.stat-change {
    font-size: 13px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-change.positive {
    color: var(--success-color);
}

.stat-change.negative {
    color: var(--danger-color);
}

.content-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
}

.content-section {
    min-width: 0;
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.card-actions {
    display: flex;
    gap: 8px;
}

.table-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    gap: 16px;
}

.toolbar-left,
.toolbar-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

.search-box {
    position: relative;
    min-width: 300px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary);
}

.search-box .form-control {
    padding-left: 40px;
}

.table-hover tbody tr:hover {
    background: var(--bg-secondary);
}

.tenant-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.tenant-logo {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}

.tenant-logo img,
.tenant-logo .avatar {
    width: 100%;
    height: 100%;
    border-radius: 8px;
    object-fit: cover;
}

.tenant-name {
    font-weight: 500;
    color: var(--text-primary);
}

.tenant-domain {
    font-size: 13px;
    color: var(--text-tertiary);
}

.text-muted {
    font-size: 13px;
    color: var(--text-tertiary);
}

.text-right {
    text-align: right;
}

.btn-group {
    display: inline-flex;
    gap: 4px;
}

.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    color: var(--primary-color);
}

.sort-icon {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-left: 4px;
}

.table-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-top: 1px solid var(--border-color);
}

.pagination-info {
    font-size: 14px;
    color: var(--text-secondary);
}

.sidebar-stats {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.activity-list {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    transition: background 0.2s;
}

.activity-item:hover {
    background: var(--bg-secondary);
}

.activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.activity-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-color); }
.activity-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
.activity-icon.info { background: rgba(59, 130, 246, 0.1); color: var(--info-color); }
.activity-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-title {
    font-size: 14px;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.activity-time {
    font-size: 12px;
    color: var(--text-tertiary);
}

.quick-stats {
    padding: 16px;
}

.quick-stat-item {
    margin-bottom: 20px;
}

.quick-stat-item:last-child {
    margin-bottom: 0;
}

.quick-stat-label {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.quick-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
}

@media (max-width: 1200px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .table-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: auto;
    }
}
</style>

<script src="{% static 'js/admin-dashboard.js' %}"></script>
{% endblock %}