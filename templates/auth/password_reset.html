{% extends "base.html" %}
{% load static %}

{% block title %}Reset Password - {{ block.super }}{% endblock %}

{% block body_class %}auth-page{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="var(--primary-color)"/>
                    <path d="M20 10L30 16.25V23.75L20 30L10 23.75V16.25L20 10Z" fill="white"/>
                </svg>
            </div>
            <h1 class="auth-title">Reset Password</h1>
            <p class="auth-subtitle">Enter your email and we'll send you a reset link</p>
        </div>

        <div class="auth-body">
            <form id="resetForm" class="auth-form" method="post">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <div class="input-group">
                        <span class="input-icon">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 5h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"/>
                                <path d="m1 7 9 5 9-5"/>
                            </svg>
                        </span>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-input" 
                            placeholder="you@example.com"
                            required
                            autofocus
                        >
                    </div>
                    <span class="form-error" id="email-error"></span>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="resetButton">
                    <span class="btn-text">Send Reset Link</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span>
                    </span>
                </button>

                <div class="success-message" id="successMessage" style="display: none;">
                    <svg width="48" height="48" fill="none" stroke="var(--success-color)" stroke-width="2">
                        <circle cx="24" cy="24" r="22"/>
                        <path d="M9 24l6 6 14-14"/>
                    </svg>
                    <h3>Check Your Email</h3>
                    <p>We've sent a password reset link to <strong id="sentEmail"></strong></p>
                    <p class="text-small">Didn't receive the email? Check your spam folder or <a href="#" id="resendLink">resend</a></p>
                </div>
            </form>
        </div>

        <div class="auth-footer">
            <p>Remember your password? <a href="{% url 'login' %}" class="auth-link">Sign in</a></p>
        </div>
    </div>
</div>

<style>
.success-message {
    text-align: center;
    padding: 2rem 0;
}

.success-message svg {
    margin-bottom: 1rem;
}

.success-message h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.success-message p {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.success-message .text-small {
    font-size: 0.875rem;
    margin-top: 1rem;
}

.success-message a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
}

.success-message a:hover {
    text-decoration: underline;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetForm');
    const resetButton = document.getElementById('resetButton');
    const successMessage = document.getElementById('successMessage');
    const emailInput = document.getElementById('email');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = emailInput.value;
        const formData = new FormData(form);
        
        // Clear previous errors
        document.getElementById('email-error').textContent = '';
        
        // Validate
        if (!email || !email.includes('@')) {
            document.getElementById('email-error').textContent = 'Please enter a valid email address';
            return;
        }
        
        // Show loading
        resetButton.disabled = true;
        resetButton.querySelector('.btn-text').style.display = 'none';
        resetButton.querySelector('.btn-loader').style.display = 'inline-flex';
        
        try {
            const response = await fetch('/api/auth/password-reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify({ email })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Hide form and show success message
                form.style.display = 'none';
                successMessage.style.display = 'block';
                document.getElementById('sentEmail').textContent = email;
            } else {
                if (result.email) {
                    document.getElementById('email-error').textContent = result.email[0];
                } else {
                    window.SaaSPlatform.showToast(result.message || 'An error occurred', 'error');
                }
            }
        } catch (error) {
            console.error('Password reset error:', error);
            window.SaaSPlatform.showToast('An error occurred. Please try again.', 'error');
        } finally {
            resetButton.disabled = false;
            resetButton.querySelector('.btn-text').style.display = 'inline';
            resetButton.querySelector('.btn-loader').style.display = 'none';
        }
    });
    
    // Resend link
    document.getElementById('resendLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        successMessage.style.display = 'none';
        form.style.display = 'block';
        window.SaaSPlatform.showToast('You can request a new reset link', 'info');
    });
});
</script>
{% endblock %}
