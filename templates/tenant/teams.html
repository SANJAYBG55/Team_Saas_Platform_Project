{% extends "layouts/app.html" %}
{% load static %}

{% block title %}Teams - {{ block.super }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Teams</h1>
        <p class="page-subtitle">Manage your teams and members</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="openModal('inviteMemberModal')">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <path d="M20 8v6M23 11h-6"/>
            </svg>
            Invite Member
        </button>
        <button class="btn btn-primary" onclick="openModal('createTeamModal')">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            Create Team
        </button>
    </div>
</div>

<!-- View Toggle -->
<div class="view-controls">
    <div class="view-toggle">
        <button class="view-btn active" data-view="grid">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
        </button>
        <button class="view-btn" data-view="list">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
            </svg>
        </button>
    </div>
    <div class="search-box">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Search teams..." id="searchTeams">
    </div>
    <select class="form-select" id="filterTeams">
        <option value="all">All Teams</option>
        <option value="owner">Teams I Own</option>
        <option value="member">Teams I'm Member Of</option>
    </select>
</div>

<!-- Teams Grid View -->
<div class="teams-container grid-view" id="teamsContainer">
    {% for team in teams %}
    <div class="team-card" data-team-id="{{ team.id }}">
        <div class="team-card-header">
            <div class="team-avatar large">{{ team.name|slice:":1" }}</div>
            <div class="team-menu">
                <button class="btn-icon" onclick="openTeamMenu(event, '{{ team.id }}')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="team-card-body" onclick="viewTeam('{{ team.id }}')">
            <h3 class="team-name">{{ team.name }}</h3>
            {% if team.description %}
            <p class="team-description">{{ team.description|truncatewords:15 }}</p>
            {% endif %}
            
            <div class="team-stats-row">
                <div class="team-stat">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <span>{{ team.members_count }} members</span>
                </div>
                <div class="team-stat">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 3v18"/>
                    </svg>
                    <span>{{ team.tasks_count }} tasks</span>
                </div>
            </div>
        </div>
        
        <div class="team-card-footer">
            <div class="team-members-preview">
                {% for member in team.members|slice:":4" %}
                <div class="avatar-sm" title="{{ member.user.get_full_name }}">
                    {{ member.user.get_initials }}
                </div>
                {% endfor %}
                {% if team.members_count > 4 %}
                <div class="avatar-sm more">+{{ team.members_count|add:"-4" }}</div>
                {% endif %}
            </div>
            
            {% if team.owner.id == request.user.id %}
            <span class="badge badge-primary">Owner</span>
            {% else %}
            <span class="badge badge-secondary">Member</span>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="empty-state-full">
        <svg width="64" height="64" fill="none" stroke="var(--text-muted)" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <h3>No Teams Yet</h3>
        <p>Create your first team to start collaborating</p>
        <button class="btn btn-primary" onclick="openModal('createTeamModal')">Create Team</button>
    </div>
    {% endfor %}
</div>

<!-- Create Team Modal -->
<div class="modal" id="createTeamModal">
    <div class="modal-overlay" onclick="closeModal('createTeamModal')"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create New Team</h2>
            <button class="modal-close" onclick="closeModal('createTeamModal')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="createTeamForm" class="modal-body">
            <div class="form-group">
                <label class="form-label">Team Name *</label>
                <input type="text" name="name" class="form-input" placeholder="e.g., Marketing Team" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-input" rows="3" placeholder="What is this team about?"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Team Color</label>
                <div class="color-picker">
                    <input type="radio" name="color" value="#2563eb" id="color1" checked>
                    <label for="color1" style="background: #2563eb;"></label>
                    
                    <input type="radio" name="color" value="#10b981" id="color2">
                    <label for="color2" style="background: #10b981;"></label>
                    
                    <input type="radio" name="color" value="#f59e0b" id="color3">
                    <label for="color3" style="background: #f59e0b;"></label>
                    
                    <input type="radio" name="color" value="#ef4444" id="color4">
                    <label for="color4" style="background: #ef4444;"></label>
                    
                    <input type="radio" name="color" value="#8b5cf6" id="color5">
                    <label for="color5" style="background: #8b5cf6;"></label>
                    
                    <input type="radio" name="color" value="#ec4899" id="color6">
                    <label for="color6" style="background: #ec4899;"></label>
                </div>
            </div>
        </form>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createTeamModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitCreateTeam()">Create Team</button>
        </div>
    </div>
</div>

<!-- Invite Member Modal -->
<div class="modal" id="inviteMemberModal">
    <div class="modal-overlay" onclick="closeModal('inviteMemberModal')"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Invite Team Member</h2>
            <button class="modal-close" onclick="closeModal('inviteMemberModal')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="inviteMemberForm" class="modal-body">
            <div class="form-group">
                <label class="form-label">Select Team *</label>
                <select name="team_id" class="form-input" required>
                    <option value="">Choose a team...</option>
                    {% for team in my_owned_teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email Address *</label>
                <input type="email" name="email" class="form-input" placeholder="colleague@company.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Role *</label>
                <select name="role" class="form-input" required>
                    <option value="MEMBER">Member - Can view and create tasks</option>
                    <option value="MANAGER">Manager - Can manage team and tasks</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Personal Message (Optional)</label>
                <textarea name="message" class="form-input" rows="3" placeholder="Add a personal note to the invitation..."></textarea>
            </div>
        </form>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('inviteMemberModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitInviteMember()">Send Invitation</button>
        </div>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
}

.view-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.view-toggle {
    display: flex;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.25rem;
}

.view-btn {
    padding: 0.5rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.view-btn:hover {
    background: var(--hover-bg);
}

.view-btn.active {
    background: var(--primary-color);
    color: white;
}

.search-box {
    flex: 1;
    max-width: 400px;
    position: relative;
    display: flex;
    align-items: center;
}

.search-box svg {
    position: absolute;
    left: 1rem;
    color: var(--text-muted);
    pointer-events: none;
}

.search-box input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.form-select {
    padding: 0.625rem 2.5rem 0.625rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 0.875rem;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
}

.teams-container.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

.team-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s;
    cursor: pointer;
}

.team-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.team-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.team-avatar.large {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    text-transform: uppercase;
}

.team-menu {
    opacity: 0;
    transition: opacity 0.2s;
}

.team-card:hover .team-menu {
    opacity: 1;
}

.team-card-body {
    margin-bottom: 1.5rem;
}

.team-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.team-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.team-stats-row {
    display: flex;
    gap: 1.5rem;
}

.team-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.team-stat svg {
    width: 16px;
    height: 16px;
}

.team-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.team-members-preview {
    display: flex;
    margin-left: -0.5rem;
}

.avatar-sm {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    border: 2px solid var(--card-bg);
    margin-left: -0.5rem;
    text-transform: uppercase;
}

.avatar-sm.more {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.empty-state-full {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state-full svg {
    margin: 0 auto 1.5rem;
}

.empty-state-full h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.empty-state-full p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

.color-picker {
    display: flex;
    gap: 0.75rem;
}

.color-picker input[type="radio"] {
    display: none;
}

.color-picker label {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.color-picker input[type="radio"]:checked + label {
    border-color: var(--text-primary);
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .view-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        max-width: none;
    }
    
    .teams-container.grid-view {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function viewTeam(teamId) {
    window.location.href = `/teams/${teamId}/`;
}

function openTeamMenu(event, teamId) {
    event.stopPropagation();
    // Implement context menu
    console.log('Open menu for team:', teamId);
}

async function submitCreateTeam() {
    const form = document.getElementById('createTeamForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await window.SaaSPlatform.apiRequest('/api/teams/', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        
        if (response.id) {
            window.SaaSPlatform.showToast('Team created successfully!', 'success');
            closeModal('createTeamModal');
            location.reload();
        }
    } catch (error) {
        window.SaaSPlatform.showToast('Failed to create team', 'error');
    }
}

async function submitInviteMember() {
    const form = document.getElementById('inviteMemberForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await window.SaaSPlatform.apiRequest('/api/team-invitations/', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        
        if (response.id) {
            window.SaaSPlatform.showToast('Invitation sent successfully!', 'success');
            closeModal('inviteMemberModal');
            form.reset();
        }
    } catch (error) {
        window.SaaSPlatform.showToast('Failed to send invitation', 'error');
    }
}

// View toggle
document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const view = this.dataset.view;
        const container = document.getElementById('teamsContainer');
        
        if (view === 'list') {
            container.classList.remove('grid-view');
            container.classList.add('list-view');
        } else {
            container.classList.remove('list-view');
            container.classList.add('grid-view');
        }
    });
});

// Search functionality
document.getElementById('searchTeams')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.team-card').forEach(card => {
        const teamName = card.querySelector('.team-name').textContent.toLowerCase();
        const teamDesc = card.querySelector('.team-description')?.textContent.toLowerCase() || '';
        
        if (teamName.includes(searchTerm) || teamDesc.includes(searchTerm)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
