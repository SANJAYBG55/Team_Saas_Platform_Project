{% extends "layouts/app.html" %}
{% load static %}

{% block title %}Tasks - {{ block.super }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Tasks</h1>
        <p class="page-subtitle">Manage and track your tasks</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="openModal('filterModal')">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/>
            </svg>
            Filter
        </button>
        <button class="btn btn-primary" onclick="openModal('createTaskModal')">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            New Task
        </button>
    </div>
</div>

<!-- View Controls -->
<div class="view-controls">
    <div class="view-toggle">
        <button class="view-btn active" data-view="board">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
            Board
        </button>
        <button class="view-btn" data-view="list">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
            </svg>
            List
        </button>
        <button class="view-btn" data-view="calendar">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <path d="M16 2v4M8 2v4M3 10h18"/>
            </svg>
            Calendar
        </button>
    </div>
    
    <div class="search-box">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Search tasks..." id="searchTasks">
    </div>
    
    <div class="quick-filters">
        <button class="filter-chip" data-filter="my-tasks">My Tasks</button>
        <button class="filter-chip" data-filter="overdue">Overdue</button>
        <button class="filter-chip" data-filter="today">Due Today</button>
        <button class="filter-chip" data-filter="this-week">This Week</button>
    </div>
</div>

<!-- Board View -->
<div class="tasks-view board-view active" id="boardView">
    <div class="board-columns">
        <!-- To Do Column -->
        <div class="board-column" data-status="TODO">
            <div class="column-header">
                <h3 class="column-title">
                    <span class="status-icon todo"></span>
                    To Do
                    <span class="column-count">{{ stats.todo_count }}</span>
                </h3>
                <button class="btn-icon" onclick="openCreateTask('TODO')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>
            </div>
            <div class="column-body" id="todoColumn">
                {% for task in todo_tasks %}
                {% include 'components/task_card.html' with task=task %}
                {% endfor %}
                {% if not todo_tasks %}
                <div class="column-empty">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="board-column" data-status="IN_PROGRESS">
            <div class="column-header">
                <h3 class="column-title">
                    <span class="status-icon in-progress"></span>
                    In Progress
                    <span class="column-count">{{ stats.in_progress_count }}</span>
                </h3>
                <button class="btn-icon" onclick="openCreateTask('IN_PROGRESS')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>
            </div>
            <div class="column-body" id="inProgressColumn">
                {% for task in in_progress_tasks %}
                {% include 'components/task_card.html' with task=task %}
                {% endfor %}
                {% if not in_progress_tasks %}
                <div class="column-empty">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- Review Column -->
        <div class="board-column" data-status="REVIEW">
            <div class="column-header">
                <h3 class="column-title">
                    <span class="status-icon review"></span>
                    Review
                    <span class="column-count">{{ stats.review_count }}</span>
                </h3>
                <button class="btn-icon" onclick="openCreateTask('REVIEW')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>
            </div>
            <div class="column-body" id="reviewColumn">
                {% for task in review_tasks %}
                {% include 'components/task_card.html' with task=task %}
                {% endfor %}
                {% if not review_tasks %}
                <div class="column-empty">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- Completed Column -->
        <div class="board-column" data-status="COMPLETED">
            <div class="column-header">
                <h3 class="column-title">
                    <span class="status-icon completed"></span>
                    Completed
                    <span class="column-count">{{ stats.completed_count }}</span>
                </h3>
                <button class="btn-icon" onclick="openCreateTask('COMPLETED')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>
            </div>
            <div class="column-body" id="completedColumn">
                {% for task in completed_tasks %}
                {% include 'components/task_card.html' with task=task %}
                {% endfor %}
                {% if not completed_tasks %}
                <div class="column-empty">No tasks</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- List View -->
<div class="tasks-view list-view" id="listView">
    <div class="content-card">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>Task</th>
                        <th>Team</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Assigned To</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody">
                    {% for task in all_tasks %}
                    <tr>
                        <td>
                            <input type="checkbox" value="{{ task.id }}">
                        </td>
                        <td>
                            <div class="task-title-cell" onclick="viewTask('{{ task.id }}')">
                                {{ task.title }}
                            </div>
                        </td>
                        <td>
                            <span class="team-badge">{{ task.team.name }}</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ task.status|lower }}">{{ task.get_status_display }}</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ task.priority|lower }}">{{ task.priority }}</span>
                        </td>
                        <td>
                            {% if task.assigned_to %}
                            <div class="user-cell">
                                <div class="avatar-xs">{{ task.assigned_to.get_initials }}</div>
                                <span>{{ task.assigned_to.get_full_name }}</span>
                            </div>
                            {% else %}
                            <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.due_date %}
                            <span class="{% if task.is_overdue %}text-error{% endif %}">
                                {{ task.due_date|date:"M d, Y" }}
                            </span>
                            {% else %}
                            <span class="text-muted">No date</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" title="View" onclick="viewTask('{{ task.id }}')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 8s3-6 9-6 9 6 9 6-3 6-9 6-9-6-9-6z"/>
                                        <circle cx="10" cy="8" r="3"/>
                                    </svg>
                                </button>
                                <button class="btn-icon" title="Edit" onclick="editTask('{{ task.id }}')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon text-error" title="Delete" onclick="deleteTask('{{ task.id }}')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="tasks-view calendar-view" id="calendarView">
    <div class="content-card">
        <div class="calendar-header">
            <h2 id="calendarMonth">November 2025</h2>
            <div class="calendar-nav">
                <button class="btn-icon" onclick="previousMonth()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="goToToday()">Today</button>
                <button class="btn-icon" onclick="nextMonth()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="calendar"></div>
    </div>
</div>

<!-- Create Task Modal -->
<div class="modal large" id="createTaskModal">
    <div class="modal-overlay" onclick="closeModal('createTaskModal')"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create New Task</h2>
            <button class="modal-close" onclick="closeModal('createTaskModal')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="createTaskForm" class="modal-body">
            <div class="form-row">
                <div class="form-group flex-2">
                    <label class="form-label">Task Title *</label>
                    <input type="text" name="title" class="form-input" placeholder="Enter task title..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority *</label>
                    <select name="priority" class="form-input" required>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-input" rows="4" placeholder="Add task description..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Team *</label>
                    <select name="team_id" class="form-input" required>
                        <option value="">Select team...</option>
                        {% for team in my_teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select name="status" class="form-input" required>
                        <option value="TODO">To Do</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="REVIEW">Review</option>
                        <option value="COMPLETED">Completed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Assign To</label>
                    <select name="assigned_to_id" class="form-input">
                        <option value="">Unassigned</option>
                        {% for member in team_members %}
                        <option value="{{ member.user.id }}">{{ member.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" name="due_date" class="form-input">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Labels</label>
                <div class="labels-input">
                    <input type="text" class="form-input" placeholder="Add labels..." id="labelInput">
                    <div class="selected-labels" id="selectedLabels"></div>
                </div>
            </div>
        </form>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createTaskModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitCreateTask()">Create Task</button>
        </div>
    </div>
</div>

<style>
.board-view {
    display: none;
}

.board-view.active {
    display: block;
}

.board-columns {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    min-height: 600px;
}

.board-column {
    background: var(--hover-bg);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border-color);
}

.column-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.status-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-icon.todo { background: #6b7280; }
.status-icon.in-progress { background: #f59e0b; }
.status-icon.review { background: #8b5cf6; }
.status-icon.completed { background: #10b981; }

.column-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 0.5rem;
    background: var(--card-bg);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.column-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.column-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.list-view,
.calendar-view {
    display: none;
}

.list-view.active,
.calendar-view.active {
    display: block;
}

.quick-filters {
    display: flex;
    gap: 0.5rem;
}

.filter-chip {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--text-secondary);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-chip:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.filter-chip.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.task-title-cell {
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
}

.task-title-cell:hover {
    color: var(--primary-color);
}

.team-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--hover-bg);
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.user-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.avatar-xs {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.calendar-nav {
    display: flex;
    gap: 0.5rem;
}

.labels-input {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.selected-labels {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.label-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: var(--primary-color);
    color: white;
    border-radius: 16px;
    font-size: 0.875rem;
}

.label-tag button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    display: flex;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-row .flex-2 {
    grid-column: span 2;
}

@media (max-width: 1400px) {
    .board-columns {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .board-columns {
        grid-template-columns: 1fr;
    }
    
    .quick-filters {
        display: none;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-row .flex-2 {
        grid-column: span 1;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{% static 'js/tasks-kanban.js' %}"></script>
<script src="{% static 'js/tasks-list.js' %}"></script>
<script src="{% static 'js/tasks-calendar.js' %}"></script>
<script src="{% static 'js/task-modal.js' %}"></script>
<script src="{% static 'js/tasks-main.js' %}"></script>
{% endblock %}
