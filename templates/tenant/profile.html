{% extends "layouts/app.html" %}
{% load static %}

{% block title %}Profile & Settings - {{ block.super }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Profile & Settings</h1>
        <p class="page-subtitle">Manage your personal information and preferences</p>
    </div>
</div>

<!-- Settings Tabs -->
<div class="tabs-container">
    <div class="tabs">
        <button class="tab active" data-tab="profile">Profile</button>
        <button class="tab" data-tab="account">Account</button>
        <button class="tab" data-tab="notifications">Notifications</button>
        <button class="tab" data-tab="preferences">Preferences</button>
        <button class="tab" data-tab="security">Security</button>
    </div>
</div>

<!-- Profile Tab -->
<div class="tab-content active" data-tab="profile">
    <div class="settings-grid">
        <div class="settings-section">
            <h2 class="section-title">Profile Information</h2>
            <p class="section-description">Update your photo and personal details</p>
            
            <form id="profileForm" class="settings-form">
                <!-- Avatar Upload -->
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="avatarPreview">
                            {% if request.user.avatar %}
                            <img src="{{ request.user.avatar.url }}" alt="{{ request.user.get_full_name }}">
                            {% else %}
                            <div class="avatar-placeholder">{{ request.user.first_name|slice:":1" }}{{ request.user.last_name|slice:":1" }}</div>
                            {% endif %}
                        </div>
                        <div class="avatar-actions">
                            <input type="file" id="avatarInput" name="avatar" accept="image/*" hidden>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                                Upload Photo
                            </button>
                            {% if request.user.avatar %}
                            <button type="button" class="btn btn-secondary" onclick="removeAvatar()">Remove</button>
                            {% endif %}
                            <small class="form-help">JPG, PNG or GIF. Max size 2MB</small>
                        </div>
                    </div>
                </div>

                <!-- Name Fields -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" name="first_name" class="form-input" value="{{ request.user.first_name }}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" name="last_name" class="form-input" value="{{ request.user.last_name }}" required>
                    </div>
                </div>

                <!-- Email (readonly) -->
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" value="{{ request.user.email }}" readonly disabled>
                    <small class="form-help">Email cannot be changed</small>
                </div>

                <!-- Job Title -->
                <div class="form-group">
                    <label class="form-label">Job Title</label>
                    <input type="text" name="job_title" class="form-input" value="{{ request.user.job_title|default:'' }}" placeholder="e.g., Product Manager">
                </div>

                <!-- Phone -->
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" name="phone" class="form-input" value="{{ request.user.phone|default:'' }}" placeholder="+1234567890">
                </div>

                <!-- Bio -->
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea name="bio" class="form-input" rows="4" placeholder="Tell us about yourself">{{ request.user.bio|default:'' }}</textarea>
                </div>

                <!-- Timezone -->
                <div class="form-group">
                    <label class="form-label">Timezone</label>
                    <select name="timezone" class="form-input">
                        <option value="UTC" {% if request.user.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                        <option value="America/New_York" {% if request.user.timezone == 'America/New_York' %}selected{% endif %}>Eastern Time (ET)</option>
                        <option value="America/Chicago" {% if request.user.timezone == 'America/Chicago' %}selected{% endif %}>Central Time (CT)</option>
                        <option value="America/Denver" {% if request.user.timezone == 'America/Denver' %}selected{% endif %}>Mountain Time (MT)</option>
                        <option value="America/Los_Angeles" {% if request.user.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time (PT)</option>
                        <option value="Europe/London" {% if request.user.timezone == 'Europe/London' %}selected{% endif %}>London (GMT)</option>
                        <option value="Europe/Paris" {% if request.user.timezone == 'Europe/Paris' %}selected{% endif %}>Paris (CET)</option>
                        <option value="Asia/Dubai" {% if request.user.timezone == 'Asia/Dubai' %}selected{% endif %}>Dubai (GST)</option>
                        <option value="Asia/Kolkata" {% if request.user.timezone == 'Asia/Kolkata' %}selected{% endif %}>India (IST)</option>
                        <option value="Asia/Singapore" {% if request.user.timezone == 'Asia/Singapore' %}selected{% endif %}>Singapore (SGT)</option>
                        <option value="Asia/Tokyo" {% if request.user.timezone == 'Asia/Tokyo' %}selected{% endif %}>Tokyo (JST)</option>
                        <option value="Australia/Sydney" {% if request.user.timezone == 'Australia/Sydney' %}selected{% endif %}>Sydney (AEDT)</option>
                    </select>
                </div>

                <!-- Language -->
                <div class="form-group">
                    <label class="form-label">Language</label>
                    <select name="language" class="form-input">
                        <option value="en" {% if request.user.language == 'en' %}selected{% endif %}>English</option>
                        <option value="es" {% if request.user.language == 'es' %}selected{% endif %}>Spanish</option>
                        <option value="fr" {% if request.user.language == 'fr' %}selected{% endif %}>French</option>
                        <option value="de" {% if request.user.language == 'de' %}selected{% endif %}>German</option>
                        <option value="it" {% if request.user.language == 'it' %}selected{% endif %}>Italian</option>
                        <option value="pt" {% if request.user.language == 'pt' %}selected{% endif %}>Portuguese</option>
                        <option value="ja" {% if request.user.language == 'ja' %}selected{% endif %}>Japanese</option>
                        <option value="zh" {% if request.user.language == 'zh' %}selected{% endif %}>Chinese</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm('profileForm')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Account Tab -->
<div class="tab-content" data-tab="account">
    <div class="settings-grid">
        <div class="settings-section">
            <h2 class="section-title">Account Information</h2>
            <p class="section-description">Your account details and organization</p>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Account Status</div>
                    <div class="info-value">
                        {% if request.user.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-error">Inactive</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Role</div>
                    <div class="info-value">
                        <span class="badge badge-primary">{{ request.user.get_role_display }}</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Organization</div>
                    <div class="info-value">{{ request.user.tenant.name }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Member Since</div>
                    <div class="info-value">{{ request.user.date_joined|date:"M d, Y" }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Last Login</div>
                    <div class="info-value">
                        {% if request.user.last_login %}
                        {{ request.user.last_login|date:"M d, Y H:i" }}
                        {% else %}
                        Never
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Email Verified</div>
                    <div class="info-value">
                        {% if request.user.is_email_verified %}
                        <span class="badge badge-success">Verified</span>
                        {% else %}
                        <span class="badge badge-warning">Not Verified</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Tab -->
<div class="tab-content" data-tab="notifications">
    <div class="settings-grid">
        <div class="settings-section">
            <h2 class="section-title">Notification Preferences</h2>
            <p class="section-description">Manage how you receive notifications</p>
            
            <form id="notificationsForm" class="settings-form">
                <div class="notification-section">
                    <h3 class="subsection-title">Email Notifications</h3>
                    
                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Task Assignments</div>
                            <div class="notification-description">Get notified when a task is assigned to you</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="task_assigned_notification" {% if user.preferences.task_assigned_notification %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Task Due Reminders</div>
                            <div class="notification-description">Reminders for upcoming task deadlines</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="task_due_notification" {% if user.preferences.task_due_notification %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Team Invitations</div>
                            <div class="notification-description">Get notified when you're invited to a team</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="team_invitation_notification" {% if user.preferences.team_invitation_notification %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Comments & Mentions</div>
                            <div class="notification-description">Notifications for comments and @mentions</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="comment_notification" {% if user.preferences.comment_notification %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="notification-section">
                    <h3 class="subsection-title">General Settings</h3>
                    
                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Email Notifications</div>
                            <div class="notification-description">Master toggle for all email notifications</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="email_notifications" {% if user.preferences.email_notifications %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Push Notifications</div>
                            <div class="notification-description">Browser push notifications when available</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="push_notifications" {% if user.preferences.push_notifications %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preferences Tab -->
<div class="tab-content" data-tab="preferences">
    <div class="settings-grid">
        <div class="settings-section">
            <h2 class="section-title">Display Preferences</h2>
            <p class="section-description">Customize your workspace appearance</p>
            
            <form id="preferencesForm" class="settings-form">
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="theme" value="light" {% if user.preferences.theme == 'light' %}checked{% endif %}>
                            <div class="radio-content">
                                <div class="radio-icon">‚òÄÔ∏è</div>
                                <div class="radio-label">Light</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="theme" value="dark" {% if user.preferences.theme == 'dark' %}checked{% endif %}>
                            <div class="radio-content">
                                <div class="radio-icon">üåô</div>
                                <div class="radio-label">Dark</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="theme" value="auto" {% if user.preferences.theme == 'auto' %}checked{% endif %}>
                            <div class="radio-content">
                                <div class="radio-icon">‚öôÔ∏è</div>
                                <div class="radio-label">Auto</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Default View</label>
                    <select name="default_view" class="form-input">
                        <option value="list" {% if user.preferences.default_view == 'list' %}selected{% endif %}>List View</option>
                        <option value="board" {% if user.preferences.default_view == 'board' %}selected{% endif %}>Board View</option>
                        <option value="calendar" {% if user.preferences.default_view == 'calendar' %}selected{% endif %}>Calendar View</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Items Per Page</label>
                    <select name="items_per_page" class="form-input">
                        <option value="10" {% if user.preferences.items_per_page == 10 %}selected{% endif %}>10</option>
                        <option value="20" {% if user.preferences.items_per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if user.preferences.items_per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if user.preferences.items_per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Keyboard Shortcuts</div>
                            <div class="notification-description">Enable keyboard shortcuts for quick actions</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="keyboard_shortcuts_enabled" {% if user.preferences.keyboard_shortcuts_enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="notification-item">
                        <div class="notification-info">
                            <div class="notification-name">Collapse Sidebar</div>
                            <div class="notification-description">Start with collapsed sidebar by default</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sidebar_collapsed" {% if user.preferences.sidebar_collapsed %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Security Tab -->
<div class="tab-content" data-tab="security">
    <div class="settings-grid">
        <div class="settings-section">
            <h2 class="section-title">Change Password</h2>
            <p class="section-description">Update your password regularly for security</p>
            
            <form id="passwordForm" class="settings-form">
                <div class="form-group">
                    <label class="form-label">Current Password *</label>
                    <input type="password" name="old_password" class="form-input" required autocomplete="current-password">
                </div>

                <div class="form-group">
                    <label class="form-label">New Password *</label>
                    <input type="password" name="new_password" class="form-input" required autocomplete="new-password" minlength="8">
                    <small class="form-help">Minimum 8 characters</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm New Password *</label>
                    <input type="password" name="confirm_password" class="form-input" required autocomplete="new-password" minlength="8">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>

        <div class="settings-section">
            <h2 class="section-title">Active Sessions</h2>
            <p class="section-description">Manage your active login sessions</p>
            
            <div class="sessions-list">
                <div class="session-item current">
                    <div class="session-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2"/>
                            <path d="M8 21h8M12 17v4"/>
                        </svg>
                    </div>
                    <div class="session-info">
                        <div class="session-device">Current Session</div>
                        <div class="session-details">Windows ‚Ä¢ Chrome ‚Ä¢ {{ request.META.REMOTE_ADDR }}</div>
                        <div class="session-time">Active now</div>
                    </div>
                    <span class="badge badge-success">Current</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.settings-grid {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 800px;
}

.settings-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.section-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 2rem;
}

.settings-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.avatar-upload {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.avatar-preview {
    width: 120px;
    height: 120px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--border-color);
    flex-shrink: 0;
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 700;
    text-transform: uppercase;
}

.avatar-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.form-actions {
    display: flex;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.info-item {
    padding: 1rem;
    background: var(--hover-bg);
    border-radius: 8px;
}

.info-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.info-value {
    font-weight: 500;
    color: var(--text-primary);
}

.notification-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.notification-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.subsection-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.notification-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--hover-bg);
    border-radius: 8px;
}

.notification-info {
    flex: 1;
}

.notification-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.notification-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: 0.3s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: var(--primary-color);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(22px);
}

.radio-group {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.radio-option {
    cursor: pointer;
}

.radio-option input {
    display: none;
}

.radio-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    transition: all 0.2s;
}

.radio-option input:checked + .radio-content {
    border-color: var(--primary-color);
    background: rgba(37, 99, 235, 0.05);
}

.radio-icon {
    font-size: 2rem;
}

.radio-label {
    font-weight: 500;
    color: var(--text-primary);
}

.sessions-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.session-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.session-item.current {
    background: rgba(37, 99, 235, 0.05);
    border-color: var(--primary-color);
}

.session-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--hover-bg);
    border-radius: 8px;
    flex-shrink: 0;
    color: var(--text-secondary);
}

.session-info {
    flex: 1;
}

.session-device {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.session-details {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.session-time {
    font-size: 0.875rem;
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .form-row,
    .info-grid,
    .radio-group {
        grid-template-columns: 1fr;
    }
    
    .avatar-upload {
        flex-direction: column;
        align-items: center;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script src="{% static 'js/profile.js' %}"></script>
<script>
// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
    });
});

// Avatar preview
document.getElementById('avatarInput')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
        };
        reader.readAsDataURL(file);
    }
});

function resetForm(formId) {
    document.getElementById(formId).reset();
    location.reload();
}
</script>
{% endblock %}
